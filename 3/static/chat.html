<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YMCA Volunteer PathFinder – Chat</title>
  <style>
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .app{display:flex;height:100vh}
    .sidebar{width:300px;background:#fafbff;border-right:1px solid #e8ecf3;padding:16px}
    .content{flex:1;display:flex;flex-direction:column}
    .header{padding:16px;border-bottom:1px solid #e8ecf3;display:flex;justify-content:space-between;align-items:center}
    .chat{flex:1;overflow:auto;padding:16px;background:#f6f7fb}
    .bubble{max-width:720px;margin:10px 0;padding:12px 14px;border-radius:12px;white-space:pre-wrap;line-height:1.45}
    .user{background:#4f46e5;color:#fff;margin-left:auto;border-bottom-right-radius:4px}
    .bot{background:#fff;border:1px solid #e5e7eb;color:#111827;border-bottom-left-radius:4px}
    .inputbar{display:flex;gap:8px;padding:12px;border-top:1px solid #e8ecf3;background:#fff}
    input,textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:15px}
    button{background:#4f46e5;color:#fff;border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0;font-size:12px}
    a{color:#4f46e5;text-decoration:none}
  </style>
</head>
<body>
  <div class="app">
    <div class="content">
      <div class="header">
        <div>
          <div style="font-weight:800;font-size:18px">YMCA Volunteer PathFinder</div>
          <div style="color:#64748b;font-size:13px">Personalized volunteer guidance</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div id="auth-status" style="font-size:12px;color:#64748b"></div>
          <div id="auth-actions">
            <a href="/login" style="font-size:14px;margin-right:12px">Sign In</a>
          </div>
          <a href="/" style="font-size:14px">Home</a>
        </div>
      </div>
      <div id="chat" class="chat"></div>
      <div class="inputbar">
        <input id="msg" placeholder="Type here… (tip: say ‘My name is First Last’)" />
        <button id="send">Send</button>
      </div>
    </div>
  </div>
  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const send = document.getElementById('send');
    const authStatus = document.getElementById('auth-status');
    const authActions = document.getElementById('auth-actions');

    // Authentication management
    let authToken = localStorage.getItem('auth_token');
    let currentUser = null;
    
    if (authToken) {
      try {
        currentUser = JSON.parse(localStorage.getItem('user'));
      } catch (e) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        authToken = null;
      }
    }
    
    function updateAuthUI() {
      if (currentUser) {
        authStatus.textContent = `Signed in as ${currentUser.first_name} ${currentUser.last_name}`;
        authActions.innerHTML = '<button onclick="signOut()" style="background:none;border:1px solid #e5e7eb;color:#374151;font-size:12px;padding:4px 8px;border-radius:6px;cursor:pointer">Sign Out</button>';
      } else {
        authStatus.textContent = '';
        authActions.innerHTML = '<a href="/login" style="font-size:14px;margin-right:12px">Sign In</a>';
      }
    }
    
    function signOut() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user');
      localStorage.removeItem('auth_provider');
      authToken = null;
      currentUser = null;
      updateAuthUI();
      addBubble('assistant', 'You have been signed out. Your conversation will continue as a guest.');
    }
    
    updateAuthUI();

    let conversationId = null;

    function addBubble(role, text){
      const div = document.createElement('div');
      div.className = 'bubble ' + (role==='user'?'user':'bot');
      // Simple markdown-like formatting for emphasis and line breaks
      div.innerHTML = text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br/>');
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function getAuthHeaders() {
      const headers = {'Content-Type': 'application/json'};
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      return headers;
    }

    async function ensureConversation(){
      if(conversationId) return conversationId;
      try{
        const r = await fetch('/api/conversations', {
          method:'POST',
          headers: getAuthHeaders()
        });
        const j = await r.json();
        conversationId = j.conversation_id;
        return conversationId;
      }catch(e){ return null; }
    }

    async function ask(text){
      // If user provides name pattern, try to resolve profile first
      const nameMatch = text.match(/^(my name is|i am|i'm)\s+([A-Za-z ,.'-]+)$/i);
      if(nameMatch){
        const raw = nameMatch[2].trim();
        try{
          const pr = await fetch('/api/profile', {
            method:'POST', 
            headers: getAuthHeaders(),
            body: JSON.stringify({ name: raw })
          });
          const pj = await pr.json();
          if(pj && pj.found){
            addBubble('assistant', `
              <div style="font-size:14px;line-height:1.6">
                <div style="font-weight:800;margin-bottom:6px">Profile found for <span style=\"color:#4f46e5\">${pj.name}</span></div>
                <div style=\"background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px\">${pj.summary.replace(/\n/g,'<br/>')}</div>
                <div style=\"margin-top:8px;font-weight:700\">Top picks for you:</div>
              </div>
            `);
            if(Array.isArray(pj.recommendations)){
              pj.recommendations.slice(0,3).forEach((r,i)=>{
                const line = `<div class=\"pill\" style=\"background:#eef2ff;color:#3730a3\">${i+1}. ${r.project_name || 'Opportunity'}${r.branch? ' · '+r.branch:''}${r.score? ' · ${(r.score*100).toFixed(0)}% match':''}</div>`;
                addBubble('assistant', line);
              });
            }
            // seed profile into AI context via a hidden system message by asking a short follow-up
            window._lastProfile = pj; // keep on window for future use if needed
            // Continue normal chat with a contextual follow-up
            text = `Consider my profile above. ${text}`;
          }else{
            addBubble('assistant', pj.message || 'I could not find your record. Try the exact name as in the system (e.g., "First Last").');
          }
        }catch(e){ addBubble('assistant', 'Error analyzing your profile. Try again.'); }
      }
      addBubble('user', text);
      input.value='';
      await ensureConversation();
      try{
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ message: text, conversation_id: conversationId })
        });
        const j = await r.json();
        addBubble('assistant', j.response || 'Sorry, something went wrong.');
      }catch(e){
        addBubble('assistant', 'Network error. Make sure the server is running.');
      }
    }

    send.onclick = ()=>{
      const text = input.value.trim();
      if(!text) return; ask(text);
    };
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ send.click(); }});

    // Greeting
    addBubble('assistant', 'Hi! I can help you find volunteer opportunities that match your interests, availability and branch. Could you tell me your name first?');
  </script>
</body>
</html>
